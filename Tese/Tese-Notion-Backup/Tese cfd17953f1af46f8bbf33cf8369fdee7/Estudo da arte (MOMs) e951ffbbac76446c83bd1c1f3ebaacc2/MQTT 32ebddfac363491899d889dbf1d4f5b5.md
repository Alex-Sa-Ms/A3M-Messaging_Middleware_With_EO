# MQTT

***Message Queuing Telemetry Transport***

---

# Visão Geral

É um **protocolo de comunicação** (nível de aplicação)

- essencialmente para **IoT** (Internet of Things)
    - focado em permite uma **transmissão estável** entre dispositivos com **hardware extremamente limitado** e que se localizem em locais remotos com **redes de alta latência e baixa largura de banda**
- **leve**, com uma **estrutura de mensagens compacta**
- segue o padrão **publish-subscribe**
- **machine-to-machine**
- **message queueing service**
- necessita de um protocolo de transporte que forneça conexões ordenadas, sem perdas e bidirecionais.

O protocolo define dois tipos de entidades: ***message broker*** e **clientes**. O *message broker* é responsável por receber todas as mensagens dos clientes e encaminhá-las para o cliente destino apropriado. 

A informação é organizada de forma hierárquica por **tópicos**. Um *publisher,* quando tem um novo item de dados para distribuir, manda uma mensagem de controlo para o *broker,* que então encaminha a mensagem para todos os *subscribers* que subscreveram o tópico. Se não houverem subscritores para o tópico e a mensagem não for marcada pelo publicador como uma mensagem a ser mantida, então a mensagem é descartada. O *broker* mantém, no máximo, uma (1) mensagem por cada tópico. Isto permite que os novos subscritores recebam a atualização mais recente, sem ter de esperar pela próxima atualização.

Uma mensagem de controlo pode ter como tamanho mínimo, 2 bytes de dados, como pode conter perto de 256 Megabytes de dados. Possui 14 tipos de mensagens. 

- *Header:*

![Untitled](MQTT%2032ebddfac363491899d889dbf1d4f5b5/Untitled.png)

As credenciais de conexão são enviadas em formato de texto simples, mas pode ser usado TLS para encriptar e proteger os dados.

---

# Message types

- **Connect:** Espera que a conexão seja estabelecida com o servidor e cria um link entre os nodos.
- **Disconnect:** Espera que o *cliente MQTT* finalize todo o trabalho que tem de realizar, e espera que a sessão TCP/IP seja desconectada.
- **Publish:** Retorna imediatamente à thread da aplicação depois de passar o pedido para o *cliente MQTT*

![Example of an MQTT connection (QoS 0) with connect, publish/subscribe, and disconnect. The first message from client B is stored due to the retain flag.](MQTT%2032ebddfac363491899d889dbf1d4f5b5/300px-MQTT_protocol_example_without_QoS.svg.png)

Example of an MQTT connection (QoS 0) with connect, publish/subscribe, and disconnect. The first message from client B is stored due to the retain flag.

---

# Quality of Service (Qos)

Cada conexão com um broker tem de especificar uma medida QoS. Ordenadas, de forma crescente, relativamente ao overhead:

- **At most once:** a mensagem é enviada apenas uma vez, não sendo necessários passos adicionais para identificar se a mensagem chegou ao destino;
- **At least once:** a mensagem é reenviada múltiplas vezes até ser recebido um acknowledgment;
- **Exactly once:** o transmissor e o receptor comunicam de forma a garantir que apenas uma cópia da mensagem é recebida (entrega garantida).

---

# MQTT over Exon

Como referido em [https://www.notion.so/MQTT-32ebddfac363491899d889dbf1d4f5b5?pvs=4#836eb67e610b401eb5c481c4af2c99ea](MQTT%2032ebddfac363491899d889dbf1d4f5b5.md), ***Exon*** pode servir como o protocolo de transporte para MQTT, sendo apenas necessário a API permitir uma entrega ordenada das mensagens.

### Limitações do TCP

TCP é limitado quando os dispositivos se encontram inseridos em redes complexas, remotas, com latências altas, e larguras de banda baixa. Alguns dos pontos negativos do TCP, que fazem deste um protocolo não ideal para IoT, são:

- frequentes interrupções de conexão devido a troca de rede;
- dificuldade no reestabelecimento da conexão após uma quebra:
    - por causa da lentidão do sistema operativo a detetar a desconexão, e por causa do grande overhead ao reconectar, entre o servidor e o cliente;
- num ambiente com mau sinal de rede, a transmissão é bloqueada pela congestão, perda de pacotes e retransmissão;

*(Exemplo: utilizadores conectados em movimento num carro ao passarem por zonas sem sinal ou quando é feita a mudança de estação base)*

### Porque escolher o Exon em vez de TCP?

…. Escrever as limitacoes do TCP

---

### Bibliografia:

[https://en.wikipedia.org/wiki/MQTT](https://en.wikipedia.org/wiki/MQTT)

[https://www.hivemq.com/mqtt/](https://www.hivemq.com/mqtt/)

[https://www.emqx.com/en/blog/mqtt-over-quic](https://www.emqx.com/en/blog/mqtt-over-quic)

[https://mqtt.org/getting-started/](https://mqtt.org/getting-started/)

[https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html)

[https://www.youtube.com/playlist?list=PLRkdoPznE1EMXLW6XoYLGd4uUaB6wB0wd](https://www.youtube.com/playlist?list=PLRkdoPznE1EMXLW6XoYLGd4uUaB6wB0wd)

[https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html](https://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html)

[https://www.hivemq.com/mqtt/mqtt-5/](https://www.hivemq.com/mqtt/mqtt-5/)

[https://stackoverflow.com/questions/30955110/is-message-order-preserved-in-mqtt-messages](https://stackoverflow.com/questions/30955110/is-message-order-preserved-in-mqtt-messages)